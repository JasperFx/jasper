<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Security Extensions | Alba</title>
    <meta name="description" content="Supercharged integration testing for ASP.Net Core web services">
    <link rel="stylesheet" href="/alba/assets/style.13643d27.css">
    <link rel="modulepreload" href="/alba/assets/Home.f54f201e.js">
    <link rel="modulepreload" href="/alba/assets/AlgoliaSearchBox.64ea36d5.js">
    <link rel="modulepreload" href="/alba/assets/app.bb080ae4.js">
    <link rel="modulepreload" href="/alba/assets/guide_security.md.35a35827.lean.js">
    
    <meta name="twitter:title" content="Security Extensions | Alba">
    <meta property="og:title" content="Security Extensions | Alba">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/alba/" aria-label="Alba, back to home" data-v-675d8756 data-v-4a583abe><!----> Alba</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/alba/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://gitter.im/JasperFx/alba?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Gitter | Join Chat <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/JasperFx/alba" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/alba/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://gitter.im/JasperFx/alba?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Gitter | Join Chat <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/JasperFx/alba" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/guide/">Getting Started</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/guide/hosting">Alba Setup</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/guide/xunit">Integrating with xUnit.Net</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/guide/nunit">Integrating with NUnit</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/guide/extensions">Extension Model</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/alba/guide/security">Security Extensions</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#stub-out-all-authentication">Stub out all authentication</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#stub-out-jwt-authentication">Stub out JWT authentication</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#integration-with-jwt-authentication">Integration with JWT Authentication</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#windows-authentication">Windows Authentication</a><!----></li></ul></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/">Scenario Testing</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/setup">Set up and tear down actions</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/urls">Specifying Urls</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/statuscode">HTTP Status Codes</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/headers">HTTP Headers</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/json">Json Web Services</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/xml">Xml Web Services</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/text">Plain Text Web Services</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/assertions">Custom Assertions</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/alba/scenarios/redirects">Redirects</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="security-extensions" tabindex="-1">Security Extensions <a class="header-anchor" href="#security-extensions" aria-hidden="true">#</a></h1><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Alba 3.0+ removed the previous, built in support for windows authentication.</p></div><h2 id="stub-out-all-authentication" tabindex="-1">Stub out all authentication <a class="header-anchor" href="#stub-out-all-authentication" aria-hidden="true">#</a></h2><p>To just stub out all possible authentication inside your ASP.Net Core system in testing, you can use the new <code>AuthenticationStub</code> to automatically authenticate every request and build out a <code>ClaimsPrincipal</code> to your specification.</p><p>Here&#39;s a sample of bootstrapping an <code>AlbaHost</code> with the <code>AuthenticationStub</code>:</p><p><a id="snippet-sample_bootstrapping_with_stub_extension"></a></p><div class="language-cs"><pre><code><span class="token comment">// This is calling your real web service&#39;s configuration</span>
<span class="token class-name"><span class="token keyword">var</span></span> hostBuilder <span class="token operator">=</span> WebAppSecuredWithJwt<span class="token punctuation">.</span>Program
    <span class="token punctuation">.</span><span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is a new Alba v5 extension that can &quot;stub&quot; out</span>
<span class="token comment">// JWT token authentication</span>
<span class="token class-name"><span class="token keyword">var</span></span> securityStub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthenticationStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>JwtRegisteredClaimNames<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> <span class="token string">&quot;guy@company.com&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">WithName</span><span class="token punctuation">(</span><span class="token string">&quot;jeremy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// AlbaHost was &quot;SystemUnderTest&quot; in previous versions of</span>
<span class="token comment">// Alba</span>
theHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AlbaHost</span><span class="token punctuation">(</span>hostBuilder<span class="token punctuation">,</span> securityStub<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Alba.Testing/Security/web_api_authentication_with_stub.cs#L21-L38" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_bootstrapping_with_stub_extension" title="Start of snippet">anchor</a></sup></p><p>When you need to test scenarios with different claims than the &quot;baseline&quot; claims defined on the <code>AuthenticationStub</code> object you created in the <code>AlbaHost</code> setup, you can use the <code>WithClaim()</code> method as shown below to add additional claims to the principal for only one scenario as shown below:</p><p><a id="snippet-sample_specify_specific_claims"></a></p><div class="language-cs"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Fact</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">can_modify_claims_per_scenario</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Numbers</span>
    <span class="token punctuation">{</span>
        Values <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> theHost<span class="token punctuation">.</span><span class="token function">Scenario</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// This is a custom claim that would only be used for the </span>
        <span class="token comment">// JWT token in this individual test</span>
        x<span class="token punctuation">.</span><span class="token function">WithClaim</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">&quot;color&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;green&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x<span class="token punctuation">.</span><span class="token function">RemoveClaim</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">Json</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x<span class="token punctuation">.</span><span class="token function">StatusCodeShouldBeOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> principal <span class="token operator">=</span> response<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
    principal<span class="token punctuation">.</span><span class="token function">ShouldNotBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    principal<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">ShouldBe</span><span class="token punctuation">(</span><span class="token string">&quot;green&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    principal<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ShouldBeFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Alba.Testing/Security/web_api_authentication_with_stub.cs#L91-L120" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_specify_specific_claims" title="Start of snippet">anchor</a></sup></p><h2 id="stub-out-jwt-authentication" tabindex="-1">Stub out JWT authentication <a class="header-anchor" href="#stub-out-jwt-authentication" aria-hidden="true">#</a></h2><p>If you have an application that uses JWT, bearer tokens as your primary means of authentication, you can use the new <code>JwtSecurityStub</code> to automatically add a valid JWT token string to the HTTP <code>Authorization</code> header before any scenarios are executed. Similar to the <code>AuthenticationStub</code>, the <code>JwtSecurityStub</code> allows you to specify a baseline set of claims that should be in the JWT token:</p><p><a id="snippet-sample_setup_jwt_stub"></a></p><div class="language-cs"><pre><code><span class="token comment">// This is calling your real web service&#39;s configuration</span>
<span class="token class-name"><span class="token keyword">var</span></span> hostBuilder <span class="token operator">=</span> WebAppSecuredWithJwt<span class="token punctuation">.</span>Program<span class="token punctuation">.</span><span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is a new Alba v5 extension that can &quot;stub&quot; out</span>
<span class="token comment">// JWT token authentication</span>
<span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityStub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>JwtRegisteredClaimNames<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> <span class="token string">&quot;guy@company.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// AlbaHost was &quot;SystemUnderTest&quot; in previous versions of</span>
<span class="token comment">// Alba</span>
theHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AlbaHost</span><span class="token punctuation">(</span>hostBuilder<span class="token punctuation">,</span> jwtSecurityStub<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Alba.Testing/Security/web_api_authentication_with_jwt.cs#L21-L36" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_setup_jwt_stub" title="Start of snippet">anchor</a></sup></p><p>The <code>JwtSecurityStub</code> reaches into your application&#39;s configuration to find the security signing key for JWT tokens, and uses that key to sign the keys that it generates. The <code>JwtSecurityStub</code> will also disable any callouts to validate the JWT tokens with a real Open Id Connect server <strong>so you can test your service without an external token identity server running.</strong></p><p>The <code>JwtSecurityStub</code> will also honor the <code>WithClaim()</code> method to add additional claims on a scenario by scenario basis as shown in the previous section.</p><h2 id="integration-with-jwt-authentication" tabindex="-1">Integration with JWT Authentication <a class="header-anchor" href="#integration-with-jwt-authentication" aria-hidden="true">#</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>All of these extensions depend on the <code>JwtBearerOptions</code> configuration from your application. The extensions will use the <code>Authority</code> property of <code>JwtBearerOptions</code> for the Url of the OIDC token server.</p></div><p>If you want to test your ASP.Net Core web services that are authenticated by an <a href="https://openid.net/connect/" target="_blank" rel="noopener noreferrer">Open Id Connect</a> workflow <strong>and</strong> you also want to be testing through the authentication from the real OIDC identity server, Alba v5 comes with new extensions to automatically fetch and apply JWT tokens to scenario tests.</p><p>To use the OIDC <a href="https://auth0.com/docs/flows/client-credentials-flow" target="_blank" rel="noopener noreferrer">Client Credentials workflow</a>, you can use the <code>OpenConnectClientCredentials</code> extension:</p><p><a id="snippet-sample_openconnectclientcredentials"></a></p><div class="language-cs"><pre><code>oidc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenConnectClientCredentials</span>
<span class="token punctuation">{</span>
    <span class="token comment">// These three properties are mandatory, and</span>
    <span class="token comment">// would refer to matching configuration in your</span>
    <span class="token comment">// OIDC server</span>
    ClientId <span class="token operator">=</span> Config<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
    ClientSecret <span class="token operator">=</span> Config<span class="token punctuation">.</span>ClientSecret<span class="token punctuation">,</span>
    Scope <span class="token operator">=</span> Config<span class="token punctuation">.</span>ApiScope
<span class="token punctuation">}</span><span class="token punctuation">;</span>

theHost <span class="token operator">=</span> WebAppSecuredWithJwt<span class="token punctuation">.</span>Program<span class="token punctuation">.</span><span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">StartAlba</span><span class="token punctuation">(</span>oidc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Alba.Testing/Security/OpenConnectClientCredentialsTests.cs#L23-L38" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_openconnectclientcredentials" title="Start of snippet">anchor</a></sup></p><p>To use the OIDC <a href="https://docs.identityserver.io/en/release/quickstarts/2_resource_owner_passwords.html" target="_blank" rel="noopener noreferrer">Resource Owner Password Grant</a> workflow, you can use the <code>OpenConnectUserPassword</code> extension:</p><p><a id="snippet-sample_applying_openconnectuserpassword"></a></p><div class="language-cs"><pre><code>oidc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenConnectUserPassword</span>
<span class="token punctuation">{</span>
    <span class="token comment">// All of these properties are mandatory</span>
    ClientId <span class="token operator">=</span> Config<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
    ClientSecret <span class="token operator">=</span> Config<span class="token punctuation">.</span>ClientSecret<span class="token punctuation">,</span>
    UserName <span class="token operator">=</span> <span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span>
    Password <span class="token operator">=</span> <span class="token string">&quot;alice&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

theHost <span class="token operator">=</span> WebAppSecuredWithJwt<span class="token punctuation">.</span>Program<span class="token punctuation">.</span><span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">StartAlba</span><span class="token punctuation">(</span>oidc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Alba.Testing/Security/OpenConnectUserPasswordTests.cs#L23-L37" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_applying_openconnectuserpassword" title="Start of snippet">anchor</a></sup></p><p>With the <code>OpenConnectUserPassword</code> extension, you can also use a different user name and password for a single scenario with the <code>Scenario.UserAndPasswordIs(user, password)</code> extension method as shown below:</p><p><a id="snippet-sample_override_user_password"></a></p><div class="language-cs"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Fact</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">post_to_a_secured_endpoint_with_jwt_with_overridden_user_and_password</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Building the input body</span>
    <span class="token class-name"><span class="token keyword">var</span></span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Numbers</span>
    <span class="token punctuation">{</span>
        Values <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> theHost<span class="token punctuation">.</span><span class="token function">Scenario</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Alba deals with Json serialization for us</span>
        x<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">Json</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Override the user credentials for just this scenario</span>
        x<span class="token punctuation">.</span><span class="token function">UserAndPasswordIs</span><span class="token punctuation">(</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Enforce that the HTTP Status Code is 200 Ok</span>
        x<span class="token punctuation">.</span><span class="token function">StatusCodeShouldBeOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> output <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadAsJson</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Result<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span>Sum<span class="token punctuation">.</span><span class="token function">ShouldBe</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span>Product<span class="token punctuation">.</span><span class="token function">ShouldBe</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> response<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">FindFirst</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">ShouldBe</span><span class="token punctuation">(</span><span class="token string">&quot;Bob Smith&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Alba.Testing/Security/OpenConnectUserPasswordTests.cs#L146-L177" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_override_user_password" title="Start of snippet">anchor</a></sup></p><h2 id="windows-authentication" tabindex="-1">Windows Authentication <a class="header-anchor" href="#windows-authentication" aria-hidden="true">#</a></h2><p>To add support for windows authentication in your Alba specifications, we recommend checking out the <a href="https://github.com/IntelliTect/AspNetCore.TestHost.WindowsAuth" target="_blank" rel="noopener noreferrer">AspNetCore.TestHost.WindowsAuth</a> project.</p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><a class="link" href="https://github.com/JasperFx/alba/edit/master/docs/guide/security.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>Suggest changes to this page <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/alba/guide/extensions" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Extension Model</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/alba/scenarios/" data-v-38ede35f><span class="text" data-v-38ede35f>Scenario Testing</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"guide_extensions.md\":\"920ade18\",\"guide_hosting.md\":\"55a001c5\",\"guide_index.md\":\"04cd849f\",\"guide_nunit.md\":\"8cd20915\",\"guide_security.md\":\"35a35827\",\"guide_testserver.md\":\"25bdb06b\",\"guide_xunit.md\":\"ce00cc38\",\"index.md\":\"54cb6005\",\"scenarios_assertions.md\":\"7883bdf5\",\"scenarios_formdata.md\":\"b264a5d2\",\"scenarios_headers.md\":\"dc9d94e1\",\"scenarios_index.md\":\"646fc878\",\"scenarios_json.md\":\"4d3c4739\",\"scenarios_redirects.md\":\"6d0f8ae0\",\"scenarios_setup.md\":\"21225ccc\",\"scenarios_statuscode.md\":\"4d22ddcc\",\"scenarios_text.md\":\"f23596f7\",\"scenarios_urls.md\":\"e525d2f3\",\"scenarios_xml.md\":\"bf17d942\"}")</script>
    <script type="module" async src="/alba/assets/app.bb080ae4.js"></script>
    
  </body>
</html>